upstream catima_app {
  server 127.0.0.1:3000 fail_timeout=0;
}

server {
  listen 80 default_server;
  listen [::]:80 default_server;

  server_name _;

  root /var/www/catima/public;

  # Increase max body size for file uploads
  client_max_body_size 4G;

  # Keepalive timeout
  keepalive_timeout 5;

  # Timeouts
  proxy_connect_timeout 300;
  proxy_send_timeout 300;
  proxy_read_timeout 300;
  send_timeout 300;

  # Enable gzip compression
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_proxied any;
  gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
  gzip_disable "MSIE [1-6]\.";

  # Health check endpoint
  location /health {
    access_log off;
    proxy_pass http://catima_app;
  }

  # Fingerprinted assets with far-future expires
  location ~ "^/assets/.*-[0-9a-f]{32,64}\." {
    gzip_static on;
    expires max;
    add_header Cache-Control "public, immutable";
    access_log off;
  }

  # Other assets and packs
  location ~ "^/assets/" {
    gzip_static on;
    expires 1y;
    add_header Cache-Control public;
    access_log off;
  }

  # All other requests - try static files first, then proxy
  location / {
    try_files $uri/index.html $uri @proxy;
  }

  # Proxy requests to puma
  location @proxy {
    # Increase proxy buffer sizes for large headers (OAuth responses)
    proxy_buffer_size 16k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 32k;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://catima_app;
  }

  # Error pages
  error_page 500 502 503 504 /500.html;
  location = /500.html {
    internal;
  }

  error_page 404 /404.html;
  location = /404.html {
    internal;
  }

  error_page 422 /422.html;
  location = /422.html {
    internal;
  }
}

